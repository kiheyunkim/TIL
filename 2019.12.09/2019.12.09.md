## 핵심기술 이어서

* ### 네트워크

  * 노드들은 항상 긴 체인을 옳은 것으로 간주하며, 그 체인이 계속 확장하도록 작업을 수행

    * 길이가 길다는 것은 그만큼 연산이 더 많이 들어갔다는 것이기 때문에 선택한다.
    * 같은 길이의 체인이 들어온다면, 먼져 들어온 것을 채택한다.
    * 버려지는 블록은 고아(Orphan) 블록이라고 부름

  * 일시적으로 분기가 발생하더라도 이후 3~5개의 블록이 추가되는 과정에서 분기 상태가 해소되고 하나의 블록체인을 유지한다.

  * 채택되지 않은 블록에 포함된 거래는 다시 블록체인에 포함되지 않은 다른 거래들과 동일하게 취급되어 블록에 추가한다.

    

* ### 합의 알고리즘

  #### PoW(Proof of Work)

  1. 블록체인의 가장 기본적인 합의 알고리즘
  2. 거래승인 과정에 많은 컴퓨팅 파워가 필요한 어려운 작업을 수행(nonce, difficulty)
  3. 가장 긴 블록체인을 합의하고 다른 기록은 폐기(Orpan)
  4. 비트코인, 이더리움, Frontier, Homestead, Metropolis에서 사용
     

  * 장점
    * 참가자 수에 영향을 받지 않고 얼마든지 참가자를 늘릴 수 있음
      
  * 단점
    * 네트워크 상태에 따라 일부분에 불일치가 생길 경우 **최종성(finality)이 불확실**하게 되거나 성능이 저하될 수 있음
    * 채굴의 집중화와 독점 문제
    * **과도한 에너지 소비**와 같은 문제 발생

  

  #### PoS(Proof of Stake)

  1. Quantum Mechainc에 의해 2011년 비트코인 논단 강의에서 처음 제기

  2. 대량 통화를 소유하고 있는 참가자는 그 통화 가치를 지키기 위해 시스템의 신뢰성을 손실하지 않을 것을 전제

  3. 채굴 시스템에서 사용자의 소유 지분이 블록 생성권의 지분율을 나타냄

  4. 포크가 발생했을 때, 더 많은 자산을 보유한 체인을 채택

  5. 이더리움의 4번째 단계인 Serenity에서 사용

     

  * 장점

    * 지분율이 높으면 채굴 난이도가 낮아지기 떄문에 PoW와 비교해 자원 소비가 적음

    * PoW에 비해 블록의 생성 주기가 짧고 독점화를 막을 수 있음

      

  * 단점

    * 지분율이 높은 사용자가 블록을 생성할 가능성이 높아 **빈익빈 부익부** 현상이 발생

      

  #### PBFT(Practical Byzantine Fault Tolerance)

  1. Hyperledger Fabric v0.6이나 b1.0의 Orderer 서비스, R3 Corda의 Notary와 같은 프라이빗 블록체인에서 사용
  2. 약속된 행동을 하지 않는 비잔틴 노드가 존재할 수 있는 비동기 시스템에서 해당 분산시스템에  참여한 모든 노드가 성공적으로 합의를 이룰 수 있도록 개발된 합의 알고리즘

  

  * ##### 최종성(finality)의 불확실성과 성능 문제를 해결

    * 다수결로 의사 결정 후 블록을 생성 -> 블록체인의 분기가 발생하지 않음
    * 한번 확정된 블록은 변경되지 않지 않음 -> 최종성(finality) 확보
      

  * 장애에 매우 강력한 내성을 가진 알고리즘

    * 부정한 사용자라해도 과반수를 획득해야 함.
    * 프라이머리(primary)가 거짓말을 한다 해도 모든 참가자가 리더의 움직임을 감시해 거짓말이라고 판단한다면 다수결로 리더 교체를 신청이 가능

  * 언제나 참가자 전원과 의사소통을 해야함

    * 네트워크의 모든 참가자를 미리 알고 있어야함
    * **참가자가 증가하면 통신량이 증가하고 처리량이 저하**

  

  ![PBFT](./image/PBFT.png)

  1. 클라이언트가 모든 노드에 요청을 브로드캐스트
  2. 프라이머리(primary)가 순차적으로 다른 노드에 명령을 전달
  3. 각 노드는 **(2)**의 명령을 받으면 프라이머리를 포함한 모든 모드들에게 회신
  4. 각 노드는 **(3)**에서 전달한 명령을 일정 수 이상 수신하면 프라이머리를 포함한 모든 노드들에게 수신한 신호를 전송
  5. 각 노드는 **(4)**에서 보낸 명령을 일정 수 이상 수신하면 명령을 실행하고 블록을 등록해 클라이언트에 응답을 반환

  

그림1 모든 노드들이 같은 블록을 가지고 있음

2. 블록을 각자가 만들어서 연두색과 빨간색 블록을 만들어냄 그리고 전파 시키게 된다.
3. 길이가 같은 경우 먼져 들어온 녀석이 인정되고 길이가 긴 녀석이 인정된다
4. 분홍색 블록이 만들어 지고 전파를 함.
5. 오른쪽은 같기 떄문에 분홍색만 추가하여 끝남
   그러나 왼쪽은 붙였을때 빨간색이 있는 곳 보다 분홍색을 붙이는 것이 더 길기 때문에 분홍색을 채택하게 됨.
   길이가 길다는 것은 연산이 많이 들어갔다는 것이기 때문에 선택하는 거임
   버려지는 블럭은 고아(Orphan) 블럭이라고 부름.



## Reference

그림1: [링크](https://www.geeksforgeeks.org/practical-byzantine-fault-tolerancepbft/)